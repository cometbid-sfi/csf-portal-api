openapi: "3.0.3"
info:
  title: CTF Portal Authentication & Authorization API
  version: 1.0.0
  description: |
    This is a Comprehensive API for user authentication and authorization. 

    This API is designed to handle user registration, login, MFA and token management, as well as role-based access control.

    It provides endpoints for creating new users, authenticating existing users, and managing user roles and permissions.

    The API is built using AWS Lambda functions and integrated with AWS Cognito for user management and authentication.
    It is designed to be scalable and secure, with a focus on user data protection and privacy.
    The API is designed to be used by a web application or other services that require user authentication and authorization.

    This is ***The Cometbid Technology Foundation, CTF, Portal API*** documentation based on the OpenAPI 3.0 specification. You can test run the apis
    against our live server with a pre-defined request, and get instant feedback on whether there was an error in the request, or the server could not process the request for some other reasons.

    You can also test our APIs in the sandbox environment, where you can make changes and test the APIs with a more robust data without affecting the production environment.
    Our APIs are hosted on AWS, and we use the API Gateway service to manage the APIs. 

    We are constantly improving our APIs based on feedback from our users and will love to hear your feedbacks on how we can improve the API interface or format. 
    We use the OpenAPI specification to follow a design first approach in the implementation of this project!
    You can now help us improve the API whether it's by making changes to the definition itself or to the code:

    That way:
    - You can get access to the API first and offer your ideas for improvements to the API.
    - You have the benefit of using the API right away without waiting for the final release implementation.
    - With time, we can improve the API in general based on your feedback, and expose some of the new features quicker.

    Please send your feedbacks to email, **cometbid@cometbid.org**
    or visit our [support page](https://www.cometbid.org/support) to get in touch with us and if you have not done so already, join our community.
    We are looking forward to hearing from you.

    Thank you for your support!  

    **The CTF Team**  

    [The Cometbid Technology Foundation Inc.](www.cometbid.org)

    Some useful links:
    - [The CTF's Portal Backend API repository](https://github.com/cometbid-sfi/csf-portal-backend) 

    - [The source API definition for the CTF's Portal Backend appliation](https://github.com/cometbid-sfi/csf-portal-backend/blob/master/src/openapi.yaml)

  termsOfService: https://github.com/cometbid-sfi/csf-portal-backend/blob/main/LICENSE

  contact:
    name: The Cometbid Technology Foundation Inc.

    url: http://www.cometbid.org/support   

    email: support@cometbid.org

  license:
    name: MIT License

    url: https://github.com/cometbid-sfi/csf-portal-backend/blob/main/LICENSE  

externalDocs: 
  description: Visit our FAQ page for any enquiries and get answers to common questions.  

  url: http://www.cometbid.org/faq

servers:
  - url: https://{api-id}.execute-api.us-east-1.amazonaws.com/{stage}
    variables:
      api-id:
        default: your-api-id
        description: API Gateway ID
      region:
        default: 'us-east-1'
      stage:
        default: 'dev'
        description: API Deployment Stage
x-amazon-apigateway-cors:
  allowOrigins:
    - "*"
  allowMethods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowHeaders:
    - content-type
    - x-amz-date
    - authorization
    - x-api-key
    - x-amz-security-token
  maxAge: 3600
  allowCredentials: false
x-amazon-apigateway-request-validators:
  all:
    validateRequestBody: true
    validateRequestParameters: true
  params-only:
    validateRequestBody: false
    validateRequestParameters: true
x-amazon-apigateway-request-validator: params-only
x-amazon-apigateway-gateway-responses:
  DEFAULT_4XX:
    statusCode: 400
    responseTemplates:
      application/json: "{\"message\":$context.error.messageString}"
  DEFAULT_5XX:
    statusCode: 500
    responseTemplates:
      application/json: "{\"message\":$context.error.messageString}"

tags:
  - name: Authentication
    description: Authentication endpoints
  - name: Authorization
    description: Authorization and permission management
  - name: User Management
    description: User profile and account management operations
  - name: Username Recovery
    description: Username recovery operations and verification
  - name: Session
    description: Session management operations
  - name: Password Recovery
    description: Password management operations
  - name: MFA
    description: Multi-factor authentication operations
  - name: MFA Verification
    description: MFA verification and challenge response operations
  - name: Token
    description: Token management operations
  - name: Phone Verification
    description: Phone verification workflow operations
  - name: Rate Limiting
    description: Rate limiting information and status

paths:
  /account/rate-limits:
    get:
      tags:
        - Rate Limiting
      summary: Get rate limit status
      description: Retrieve current rate limit status and remaining requests
      operationId: getRateLimitStatus
      security:
        - CognitoAuth: []
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: "^[a-z]{2}-[A-Z]{2}$"
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getRateLimitStatusFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token"
              #else
                "statusCode": 200,
                "accountId": "acc-${context.requestId.substring(0,8)}",
                "tier": "standard"
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "message": "Unauthorized",
                  "error": "$input.path('$.message')"
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                #set($accountId = $input.path('$.accountId'))
                #set($tier = $input.path('$.tier'))
                #set($limits = {
                  "standard": {
                    "requests_per_second": 10,
                    "burst_limit": 20,
                    "daily_quota": 100000
                  },
                  "premium": {
                    "requests_per_second": 50,
                    "burst_limit": 100,
                    "daily_quota": 1000000
                  }
                })
                {
                  "accountId": "$accountId",
                  "tier": "$tier",
                  "currentUsage": {
                    "daily_requests": #random(1000, 50000),
                    "current_rate": #random(1, 10)
                  },
                  "limits": {
                    #if($tier == "premium")
                      "requests_per_second": $limits.premium.requests_per_second,
                      "burst_limit": $limits.premium.burst_limit,
                      "daily_quota": $limits.premium.daily_quota
                    #else
                      "requests_per_second": $limits.standard.requests_per_second,
                      "burst_limit": $limits.standard.burst_limit,
                      "daily_quota": $limits.standard.daily_quota
                    #end
                  },
                  "resetTime": "$util.time.nowFormatted()",
                  "nextResetTime": "$util.time.nowPlus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                  "throttling": {
                    "enabled": true,
                    "soft_limit": true,
                    "hard_limit": false
                  },
                  "metadata": {
                    "region": "$context.identity.sourceIp",
                    "lastUpdated": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
      responses:
        "200":
          description: Rate limit status retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RateLimitStatus"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"

  /account/username/recover:
    post:
      tags:
        - Username Recovery
      summary: Initiate username recovery
      description: Start username recovery process using personal information
      operationId: recoverUsername
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${recoverUsernameFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            {
              #if(!$body.brandName || !$body.firstName || !$body.lastName)
                "statusCode": 400,
                "message": "Missing required fields"
              #else
                "statusCode": 201,
                "data": {
                  "maskedEmail": "user-${context.requestId.substring(0,8)}@example.com",
                }"
                "message": "Your email(username) is."
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Username recovery initiated successfully",
                  "email": "$input.path('$.message') $input.path('$.data.maskedEmail')",
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UsernameRecoveryRequest"
      responses:
        "200":
          description: Username recovery initiated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsernameRecoveryResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Register a new user
      operationId: signUp
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${signUpFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            {
              #if(!$body.email || !$body.password || !$body.username)
                "statusCode": 400,
                "message": "Missing required fields"
              #elseif($body.email.indexOf("@") == -1)
                "statusCode": 400,
                "message": "Invalid email format"
              #elseif($body.password.length() < 8)
                "statusCode": 400,
                "message": "Password too short"
              #else
                "statusCode": 201,
                "email": "$body.email",
                "message": "Check your email for further steps."
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "message": "Validation Error",
                  "error": "$input.path('$.message')"
                }
          default:
            statusCode: 201
            responseTemplates:
              application/json: |
                {
                  "message": "Congrat! You have been successfully registered. $input.path('$.message')",
                  "verificationRequired": "true",
                }
        requestBody:
          required: true
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignUpRequest"
      responses:
        "201":
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignUpResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conflict"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/confirm-signup:
    get:
      tags:
        - Authentication
      summary: Confirm user registration.
      operationId: confirmSignUp
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${confirmSignUpFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        type: 'mock'
        payloadFormatVersion: "2.0"
        connectionType: INTERNET
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.session)
                "statusCode": 400,
                "message": "Verification code required",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.session == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "email": "$body.email",
                    "verified": true,
                    "verificationTimestamp": "$util.time.nowFormatted()",
                    "requestId": "$context.requestId"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many verification attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "cooldownPeriod": 300
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Email verified successfully",
                  "data": {
                    "email": "$input.path('$.data.email')",
                    "verified": $input.path('$.data.verified'),
                    "verificationTimestamp": "$input.path('$.data.verificationTimestamp')",
                    "requestId": "$input.path('$.data.requestId')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      parameters:
        - name: session
          in: query
          description: Session id for the confirm signup flow
          required: true
          schema:
            type: string
        
      responses:
        "200":
          description: Email verification successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmSignUpResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"

        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/verify-email:
    get:
      tags:
        - Authentication
      summary: Verify email address
      operationId: verifyEmail
      description: Verify user's email address using verification code
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${verifyEmailFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.session)
                "statusCode": 400,
                "message": "Verification code required",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.session == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "email": "$body.email",
                    "verified": true,
                    "verificationTimestamp": "$util.time.nowFormatted()",
                    "requestId": "$context.requestId"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many verification attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "cooldownPeriod": 300
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Email verified successfully",
                  "data": {
                    "email": "$input.path('$.data.email')",
                    "verified": $input.path('$.data.verified'),
                    "verificationTimestamp": "$input.path('$.data.verificationTimestamp')",
                    "requestId": "$input.path('$.data.requestId')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      parameters:
        - name: session
          in: query
          description: Session id for the email verification flow
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Email verification successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmailVerificationResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"

  /auth/signin:
    post:
      tags:
        - Authentication
      summary: Sign in user
      description: Authenticate user and initiate MFA if enabled
      operationId: signIn
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${signInFunctionArn}/invocations"
        #httpMethod: POST
        #connectionType: INTERNET
        #type: aws_proxy
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.username || !$body.password)
                "statusCode": 400,
                "message": "Username and password are required",
                "success": false
              #else
                #set($mockUsername = "testuser")
                #set($mockPassword = "Password123!")
                #if($body.username == $mockUsername && $body.password == $mockPassword)
                  #set($mfaEnabled = true)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "username": "$body.username",
                    "mfaRequired": $mfaEnabled,
                    "mfaToken": "mfa-${context.requestId}",
                    "sessionId": "sess-${context.requestId}",
                    "loginTimestamp": "$util.time.nowFormatted()",
                    "expiresIn": 300
                  }
                #else
                  "statusCode": 401,
                  "message": "Invalid username or password",
                  "success": false,
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "INVALID_CREDENTIALS",
                    "details": "$input.path('$.message')",
                    "remainingAttempts": $input.path('$.remainingAttempts')
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": #if($input.path('$.data.mfaRequired')) "MFA verification required" #else "Successfully signed in" #end,
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "username": "$input.path('$.data.username')",
                    "mfaRequired": $input.path('$.data.mfaRequired'),
                    #if($input.path('$.data.mfaRequired'))
                    "mfaToken": "$input.path('$.data.mfaToken')",
                    #end
                    "sessionId": "$input.path('$.data.sessionId')",
                    "loginTimestamp": "$input.path('$.data.loginTimestamp')",
                    "expiresIn": $input.path('$.data.expiresIn')
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignInRequest"
      responses:
        "200":
          description: Successfully authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignInResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Forbidden"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /user/current:
    get:
      tags:
        - User Management
      summary: Get current user details
      description: Retrieve detailed information about the authenticated user
      operationId: getCurrentUser
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getCurrentUserFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token"
              #else
                "statusCode": 200,
                "token": "$authHeader.substring(7)"
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "message": "Unauthorized",
                  "error": "$input.path('$.message')"
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                #set($userId = "user-${context.requestId}")
                {
                  "userId": "$userId",
                  "email": "user_${userId.substring(5,10)}@example.com",
                  "profile": {
                    "firstName": "John",
                    "lastName": "Doe",
                    "brandName": "our-unique-brand-name",
                    "createdAt": "$context.requestTime",
                    "lastLoginAt": "$context.requestTime",
                    "emailVerified": true,
                    "mfaEnabled": false,
                    "mfaType": "TOTP",
                    "phoneVerified": false,
                    "phoneNumber": "+1234567890",
                    "preferences": {
                      "language": "en-US",
                      "timezone": "UTC",
                      "notifications": {
                        "email": true,
                        "sms": false
                      }
                    }
                  },
                }
      responses:
        "200":
          description: User details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotFound"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"

  /auth/signout:
    post:
      tags:
        - Session
      summary: Sign out user from all devices
      description: Invalidates all refresh tokens and signs out user from all devices
      operationId: signOut
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${signOutFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #else
                #set($token = $authHeader.substring(7))
                #if($token.length() < 10)
                  "statusCode": 401,
                  "message": "Invalid token format",
                  "success": false
                #else
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "sessionId": "$context.requestId",
                    "signOutTime": "$util.time.nowFormatted()",
                    "deviceId": "$context.identity.userAgent.replaceAll('[^a-zA-Z0-9]', '')"
                  }
                #end
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many requests",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Successfully signed out",
                  "data": {
                    "sessionId": "$input.path('$.data.sessionId')",
                    "signOutTime": "$input.path('$.data.signOutTime')",
                    "deviceId": "$input.path('$.data.deviceId')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      responses:
        "200":
          description: Successfully signed out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignOutResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /auth/mfa/setup:
    post:
      tags:
        - Authentication
        - MFA
      summary: Setup Multi-Factor Authentication for a user
      description: Initialize MFA setup and generate QR code for authenticator app
      operationId: setupMFA
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${setupMFAFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #else
                #set($token = $authHeader.substring(7))
                #if($token.length() < 10)
                  "statusCode": 401,
                  "message": "Invalid token format",
                  "success": false
                #else
                  #set($userId = "user-${context.requestId.substring(0,8)}")
                  #set($secretKey = "BASE32SECRET${context.requestId.substring(0,10)}")
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "$userId",
                    "secretKey": "$secretKey",
                    "qrCode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
                    "recoveryKeys": [
                      "ABCD-EFGH-IJKL-MNOP",
                      "QRST-UVWX-YZAB-CDEF",
                      "GHIJ-KLMN-OPQR-STUV"
                    ],
                    "setupTime": "$util.time.nowFormatted()",
                    "status": "PENDING_VERIFICATION",
                    "expiresIn": 600
                  }
                #end
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many MFA setup attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again in 5 minutes",
                    "cooldownPeriod": 300
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA setup initialized successfully",
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "secretKey": "$input.path('$.data.secretKey')",
                    "qrCode": "$input.path('$.data.qrCode')",
                    "recoveryKeys": $input.json('$.data.recoveryKeys'),
                    "setupTime": "$input.path('$.data.setupTime')",
                    "status": "$input.path('$.data.status')",
                    "expiresIn": $input.path('$.data.expiresIn')
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      responses:
        "200":
          description: MFA setup initialized successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MFASetupResponse"
        "401":
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "429":
          description: Too many setup attempts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
    
    put:
      tags:
        - Authentication
        - MFA
      summary: Verify MFA setup
      description: Complete MFA setup by verifying the authenticator code
      operationId: verifyMFASetup
      security:
        - CongitoAuth: []
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${setupMFAFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: mock
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.code)
                "statusCode": 400,
                "message": "Verification code is required",
                "success": false
              #elseif($body.code.length() != 6)
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #elseif(!$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Verification code must contain only numbers",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "verificationTime": "$util.time.nowFormatted()",
                    "status": "ENABLED",
                    "nextVerificationRequired": "$util.time.nowPlus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA setup verified successfully",
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "verificationTime": "$input.path('$.data.verificationTime')",
                    "status": "$input.path('$.data.status')",
                    "nextVerificationRequired": "$input.path('$.data.nextVerificationRequired')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MFASetupVerificationRequest"
      responses:
        "200":
          description: MFA setup verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MFASetupVerificationResponse"
        "400":
          description: Bad request or invalid verification code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/mfa/verify:
    post:
      tags:
        - Authentication
        - MFA
      summary: Verify MFA code during sign-in
      description: Complete sign-in process by verifying MFA code
      operationId: verifyMFA
      security:
        - CognitoAuth: []
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${verifyMFAFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.mfaToken || !$body.code)
                "statusCode": 400,
                "message": "MFA token and verification code are required",
                "success": false
              #elseif($body.code.length() != 6)
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #elseif(!$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Verification code must contain only numbers",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
                    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
                    "tokenType": "Bearer",
                    "expiresIn": 3600,
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "sessionId": "sess-${context.requestId}",
                    "verificationTime": "$util.time.nowFormatted()",
                    "permissions": [
                      "READ",
                      "WRITE",
                      "DELETE"
                    ]
                  }
                #else
                  "statusCode": 401,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "INVALID_MFA_CODE",
                    "details": "$input.path('$.message')",
                    "remainingAttempts": $input.path('$.remainingAttempts')
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Successfully authenticated",
                  "data": {
                    "accessToken": "$input.path('$.data.accessToken')",
                    "refreshToken": "$input.path('$.data.refreshToken')",
                    "tokenType": "$input.path('$.data.tokenType')",
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "userId": "$input.path('$.data.userId')",
                    "sessionId": "$input.path('$.data.sessionId')",
                    "verificationTime": "$input.path('$.data.verificationTime')",
                    "permissions": $input.json('$.data.permissions')
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MFASigninVerificationRequest"
      responses:
        "200":
          description: MFA verification successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MFASigninVerificationResponse"
        "400":
          description: Bad request or invalid verification code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /auth/mfa/resend:
    post:
      tags:
        - Authentication
        - MFA
      summary: Resend MFA verification code
      description: Request a new MFA verification code during sign-in process
      operationId: resendMFACode
      x-amazon-apigateway-throttling:
        rateLimit: 2
        burstLimit: 3
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${resendMfaTokenFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.mfaToken)
                "statusCode": 400,
                "message": "MFA token is required",
                "success": false
              #elseif(!$body.mfaToken.startsWith("mfa-"))
                "statusCode": 400,
                "message": "Invalid MFA token format",
                "success": false
              #else
                #set($resendCount = $util.random(0, 4))
                #if($resendCount >= 3)
                  "statusCode": 429,
                  "message": "Maximum resend attempts reached",
                  "success": false,
                  "cooldownPeriod": 300
                #else
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "mfaToken": "$body.mfaToken",
                    "deliveryMethod": "EMAIL",
                    "maskedDestination": "t***t@example.com",
                    "resendCount": $resendCount,
                    "remainingResends": #set($remaining = 3 - $resendCount)$remaining,
                    "requestTime": "$util.time.nowFormatted()",
                    "expiresIn": 300,
                    "nextResendAllowed": "$util.time.nowPlus(60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Maximum resend attempts reached",
                    "cooldownPeriod": $input.path('$.cooldownPeriod'),
                    "nextAttemptAllowed": "$util.time.nowPlus($input.path('$.cooldownPeriod') * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA code resent successfully",
                  "data": {
                    "mfaToken": "$input.path('$.data.mfaToken')",
                    "deliveryMethod": "$input.path('$.data.deliveryMethod')",
                    "maskedDestination": "$input.path('$.data.maskedDestination')",
                    "resendCount": $input.path('$.data.resendCount'),
                    "remainingResends": $input.path('$.data.remainingResends'),
                    "requestTime": "$input.path('$.data.requestTime')",
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "nextResendAllowed": "$input.path('$.data.nextResendAllowed')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MFAResendRequest"
      responses:
        "200":
          description: MFA code resent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MFAResendResponse"
        "400":
          description: Bad request or invalid MFA token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many resend attempts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyMfaRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
  
  /auth/mfa/enable:
    post:
      tags:
        - Authentication
        - MFA
      summary: Enable MFA for user account
      description: Enable and configure MFA for authenticated user
      operationId: enableMfa
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 2
        burstLimit: 3
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${enableMfaFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.mfaType || !$body.code)
                "statusCode": 400,
                "message": "MFA type and verification code are required",
                "success": false
              #elseif($body.mfaType != "TOTP" && $body.mfaType != "SMS" && $body.mfaType != "EMAIL")
                "statusCode": 400,
                "message": "Invalid MFA type. Supported types: TOTP, SMS, EMAIL",
                "success": false
              #elseif($body.code.length() != 6 || !$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "mfaEnabled": true,
                    "mfaType": "$body.mfaType",
                    "enabledAt": "$util.time.nowFormatted()",
                    "backupCodes": [
                      "1234-5678",
                      "8765-4321",
                      "9876-5432"
                    ],
                    "recoveryEmail": "u***r@example.com"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }  
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA enabled successfully",
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "mfaEnabled": $input.path('$.data.mfaEnabled'),
                    "mfaType": "$input.path('$.data.mfaType')",
                    "enabledAt": "$input.path('$.data.enabledAt')",
                    "backupCodes": $input.json('$.data.backupCodes'),
                    "recoveryEmail": "$input.path('$.data.recoveryEmail')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EnableMfaRequest"
      responses:
        "200":
          description: MFA enabled successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EnableMfaResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
  
  /auth/mfa/disable:
    post:
      tags:
        - Authentication
        - MFA
      summary: Disable MFA for user
      description: Disable MFA for the authenticated user
      operationId: disableMfa
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      security:
        - CognitoAuth: []
      x-amazon-apigateway-throttling:
        rateLimit: 2
        burstLimit: 3
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${disableMfaFunctionArn}/invocations"
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($body = $input.json('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.code)
                "statusCode": 400,
                "message": "Verification code is required",
                "success": false
              #elseif($body.code.length() != 6 || !$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "mfaEnabled": false,
                    "disabledAt": "$util.time.nowFormatted()",
                    "securityNotice": "Your account security level has been reduced"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA disabled successfully",
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "mfaEnabled": $input.path('$.data.mfaEnabled'),
                    "disabledAt": "$input.path('$.data.disabledAt')",
                    "securityNotice": "$input.path('$.data.securityNotice')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DisableMfaRequest"
      responses:
        "200":
          description: MFA disabled successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DisableMfaResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"

  /auth/mfa/preferences:
    get:
      tags:
        - MFA Management
      summary: Get user MFA preferences
      description: Retrieve current MFA settings and preferences for the authenticated user
      operationId: getUserMfaPreference
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 10
        burstLimit: 20
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserMfaPreferenceFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #else
                "statusCode": 200,
                "success": true,
                "data": {
                  "userId": "user-${context.requestId.substring(0,8)}",
                  "mfaEnabled": true,
                  "defaultMethod": "TOTP",
                  "methods": {
                    "TOTP": {
                      "enabled": true,
                      "isDefault": true,
                      "lastUsed": "$util.time.nowMinus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                      "registeredAt": "$util.time.nowMinus(90 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    },
                    "SMS": {
                      "enabled": true,
                      "isDefault": false,
                      "phoneNumber": "+1****4321",
                      "lastUsed": "$util.time.nowMinus(7 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                      "registeredAt": "$util.time.nowMinus(60 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    }
                  },
                  "securitySettings": {
                    "rememberDevice": true,
                    "rememberDeviceDays": 30,
                    "requireMfaOnNewDevice": true,
                    "requireMfaOnLoginFromNewLocation": true
                  },
                  "metadata": {
                    "lastUpdated": "$util.time.nowMinus(15 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "lastVerification": "$util.time.nowMinus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                }
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA preferences retrieved successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      responses:
        "200":
          description: MFA preferences retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MfaPreferenceResponse"
        "404":
          description: Mfa preference not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotFound"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

    put:
      tags:
        - MFA Management
      summary: Update user MFA preferences
      description: Update MFA settings and preferences for the authenticated user
      operationId: setUserMfaPreference
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${setUserMfaPreferenceFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.mfaEnabled && $body.defaultMethod)
                "statusCode": 400,
                "message": "Cannot set default method when MFA is disabled",
                "success": false
              #elseif($body.mfaEnabled && !$body.defaultMethod)
                "statusCode": 400,
                "message": "Default method is required when enabling MFA",
                "success": false
              #elseif($body.defaultMethod && $body.defaultMethod != "TOTP" && $body.defaultMethod != "SMS")
                "statusCode": 400,
                "message": "Invalid MFA method. Supported methods: TOTP, SMS",
                "success": false
              #else
                "statusCode": 200,
                "success": true,
                "data": {
                  "userId": "user-${context.requestId.substring(0,8)}",
                  "mfaEnabled": #if($body.mfaEnabled)$body.mfaEnabled#{else}true#end,
                  "defaultMethod": #if($body.defaultMethod)"$body.defaultMethod"#{else}"TOTP"#end,
                  "methods": {
                    "TOTP": {
                      "enabled": true,
                      "isDefault": #if($body.defaultMethod == "TOTP")true#{else}false#end,
                      "lastUsed": "$util.time.nowMinus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                      "registeredAt": "$util.time.nowMinus(90 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    },
                    "SMS": {
                      "enabled": true,
                      "isDefault": #if($body.defaultMethod == "SMS")true#{else}false#end,
                      "phoneNumber": "+1****4321",
                      "lastUsed": "$util.time.nowMinus(7 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                      "registeredAt": "$util.time.nowMinus(60 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    }
                  },
                  "securitySettings": {
                    "rememberDevice": #if($body.securitySettings.rememberDevice)$body.securitySettings.rememberDevice#{else}true#end,
                    "rememberDeviceDays": #if($body.securitySettings.rememberDeviceDays)$body.securitySettings.rememberDeviceDays#{else}30#end,
                    "requireMfaOnNewDevice": #if($body.securitySettings.requireMfaOnNewDevice)$body.securitySettings.requireMfaOnNewDevice#{else}true#end,
                    "requireMfaOnLoginFromNewLocation": #if($body.securitySettings.requireMfaOnLoginFromNewLocation)$body.securitySettings.requireMfaOnLoginFromNewLocation#{else}true#end
                  },
                  "metadata": {
                    "lastUpdated": "$util.time.nowFormatted()",
                    "lastVerification": "$util.time.nowMinus(24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                }
              #end
            } 
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "MFA preferences updated successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MfaPreferenceRequest"
      responses:
        "200":
          description: MFA preferences updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MfaPreferenceResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/password/change:
    post:
      tags:
        - Password
      summary: Change user password
      description: Change password for authenticated user
      operationId: changePassword
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${changePasswordFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.currentPassword || !$body.newPassword)
                "statusCode": 400,
                "message": "Current password and new password are required",
                "success": false
              #elseif($body.currentPassword == $body.newPassword)
                "statusCode": 400,
                "message": "New password must be different from current password",
                "success": false
              #elseif($body.newPassword.length() < 8)
                "statusCode": 400,
                "message": "Password must be at least 8 characters long",
                "success": false
              #else
                "statusCode": 200,
                "success": true,
                "data": {
                  "userId": "user-${context.requestId.substring(0,8)}",
                  "email": "u***r@example.com",
                  "passwordUpdatedAt": "$util.time.nowFormatted()",
                  "requiresRelogin": true,
                  "securityNotification": {
                    "email": true,
                    "timestamp": "$util.time.nowFormatted()"
                  }
                }
              #end
            }   
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Password changed successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                } 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Password successfully changed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangePasswordResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /auth/password/reset-request:
    post:
      tags:
        - Password
      summary: Initiate password reset flow
      description: Send password reset code to user's email
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${requestPasswordResetFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.email)
                "statusCode": 400,
                "message": "Email is required",
                "success": false
              #elseif(!$body.email.matches("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$"))
                "statusCode": 400,
                "message": "Invalid email format",
                "success": false
              #else
                #set($maskedEmail = $body.email.substring(0,2) + "***" + $body.email.substring($body.email.indexOf("@")))
                "statusCode": 200,
                "success": true,
                "data": {
                  "resetId": "rst-${context.requestId.substring(0,8)}",
                  "email": "$maskedEmail",
                  "expiresIn": 900,
                  "resetMethod": "EMAIL",
                  "resetDestination": "$maskedEmail",
                  "nextRetryAllowed": "$util.time.nowPlus(60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                  "requestTimestamp": "$util.time.nowFormatted()"
                }
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many reset attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "nextAttemptAllowed": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Password reset initiated successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasswordResetRequest"
      responses:
        "200":
          description: Password reset email sent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasswordResetResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /auth/password/reset:
    post:
      tags:
        - Password
      summary: Complete reset password flow
      description: Complete password reset with verification code
      security:
        - CognitoAuth: []
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${resetPasswordFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.resetId || !$body.code || !$body.newPassword)
                "statusCode": 400,
                "message": "Reset ID, verification code, and new password are required",
                "success": false
              #elseif($body.code.length() != 6 || !$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #elseif($body.newPassword.length() < 8)
                "statusCode": 400,
                "message": "Password must be at least 8 characters long",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "email": "u***r@example.com",
                    "passwordUpdatedAt": "$util.time.nowFormatted()",
                    "requiresRelogin": true,
                    "securityNotification": {
                      "email": true,
                      "timestamp": "$util.time.nowFormatted()"
                    }
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "410":
            statusCode: 410
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Reset code has expired",
                  "error": {
                    "code": "CODE_EXPIRED",
                    "details": "Please request a new reset code"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many reset attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "nextAttemptAllowed": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Password reset successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmResetPasswordRequest"
      responses:
        "200":
          description: Password successfully reset
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResetPasswordResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /auth/refresh-token:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get new access token using refresh token
      operationId: refreshToken
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${refreshTokenFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.refreshToken)
                "statusCode": 400,
                "message": "Refresh token is required",
                "success": false
              #elseif(!$body.refreshToken.startsWith("rt_"))
                "statusCode": 400,
                "message": "Invalid refresh token format",
                "success": false
              #else
                #set($validToken = "rt_valid_token")
                #if($body.refreshToken == $validToken)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "accessToken": "at_${context.requestId}",
                    "refreshToken": "rt_${context.requestId}",
                    "tokenType": "Bearer",
                    "expiresIn": 3600,
                    "refreshExpiresIn": 2592000,
                    "scope": "openid profile email",
                    "issuedAt": "$util.time.nowFormatted()",
                    "sessionId": "sess_${context.requestId.substring(0,8)}",
                    "deviceInfo": {
                      "deviceId": "dev_${context.requestId.substring(0,8)}",
                      "ipAddress": "$context.identity.sourceIp",
                      "userAgent": "$context.identity.userAgent",
                      "location": "Unknown"
                    }
                  }
                #else
                  "statusCode": 401,
                  "message": "Invalid or expired refresh token",
                  "success": false,
                  "error": {
                    "code": "INVALID_REFRESH_TOKEN",
                    "requiresReauthentication": true
                  }
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "$input.path('$.error.code')",
                    "details": "$input.path('$.message')",
                    "requiresReauthentication": true
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many token refresh attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "nextAttemptAllowed": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Token refreshed successfully",
                  "data": {
                    "userId": "$input.path('$.data.userId')",
                    "accessToken": "$input.path('$.data.accessToken')",
                    "refreshToken": "$input.path('$.data.refreshToken')",
                    "tokenType": "$input.path('$.data.tokenType')",
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "refreshExpiresIn": $input.path('$.data.refreshExpiresIn'),
                    "scope": "$input.path('$.data.scope')",
                    "issuedAt": "$input.path('$.data.issuedAt')",
                    "sessionId": "$input.path('$.data.sessionId')",
                    "deviceInfo": {
                      "deviceId": "$input.path('$.data.deviceInfo.deviceId')",
                      "ipAddress": "$input.path('$.data.deviceInfo.ipAddress')",
                      "userAgent": "$input.path('$.data.deviceInfo.userAgent')",
                      "location": "$input.path('$.data.deviceInfo.location')"
                    }
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: Token successfully refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshTokenResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "403":
          description: Refresh token is expired or invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Forbidden"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/forgot-password:
    post:
      tags:
        - Password
      summary: Initiate forgot password flow
      description: Send password reset code to user's email
      operationId: forgotPassword
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${forgotPasswordFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.email)
                "statusCode": 400,
                "message": "Email is required",
                "success": false
              #elseif(!$body.email.matches("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$"))
                "statusCode": 400,
                "message": "Invalid email format",
                "success": false
              #else
                #set($maskedEmail = $body.email.substring(0,2) + "***" + $body.email.substring($body.email.indexOf("@")))
                "statusCode": 200,
                "success": true,
                "data": {
                  "recoveryId": "rec-${context.requestId.substring(0,8)}",
                  "email": "$maskedEmail",
                  "expiresIn": 900,
                  "recoveryMethod": "EMAIL",
                  "recoveryDestination": "$maskedEmail",
                  "nextRetryAllowed": "$util.time.nowPlus(60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                  "requestTimestamp": "$util.time.nowFormatted()"
                }
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many attempts. Please try again later",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Maximum attempts reached",
                    "nextAttemptAllowed": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Recovery code sent successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ForgotPasswordRequest"
      responses:
        "200":
          description: Reset code sent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ForgotPasswordResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/verify-code:
    post:
      tags:
        - Password Recovery
      summary: Verify recovery code
      description: Verify the code sent during reset/forgot-password flow
      operationId: verifyRecoveryCode
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${verifyAccountRecoveryFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.recoveryId || !$body.code)
                "statusCode": 400,
                "message": "Recovery ID and verification code are required",
                "success": false
              #elseif($body.code.length() != 6 || !$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "recoveryId": "$body.recoveryId",
                    "email": "u***r@example.com",
                    "verificationStatus": "VERIFIED",
                    "verifiedAt": "$util.time.nowFormatted()",
                    "validUntil": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "resetToken": "rst-${context.requestId}"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "410":
            statusCode: 410
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Recovery code has expired",
                  "error": {
                    "code": "CODE_EXPIRED",
                    "details": "Please request a new recovery code"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Code verified successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AccountRecoveryVerificationRequest"
      responses:
        "200":
          description: Account recovery verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountRecoveryVerificationResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotFound"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"

  /auth/forgot-password/confirm:
    post:
      tags:
        - Password Recovery
      summary: Complete forgot password flow
      description: Set new password after successful verification
      operationId: confirmForgotPassword
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${confirmForgotPasswordFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$body.recoveryId || !$body.resetToken || !$body.newPassword)
                "statusCode": 400,
                "message": "Recovery ID, reset token and new password are required",
                "success": false
              #elseif($body.newPassword.length() < 8)
                "statusCode": 400,
                "message": "Password must be at least 8 characters long",
                "success": false
              #else
                "statusCode": 200,
                "success": true,
                "data": {
                  "userId": "user-${context.requestId.substring(0,8)}",
                  "email": "u***r@example.com",
                  "passwordUpdatedAt": "$util.time.nowFormatted()",
                  "requiresRelogin": true,
                  "securityNotice": "Your password has been successfully reset"
                }
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Invalid or expired reset token",
                  "error": {
                    "code": "INVALID_TOKEN",
                    "details": "Please restart the password recovery process"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Password reset successful",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmForgotPasswordRequest"
      responses:
        "200":
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmForgotPasswordResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TooManyRequests"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /user/attributes:
    get:
      tags:
        - User Management
      summary: Get user attributes
      description: Retrieve user profile attributes and preferences
      operationId: getUserAttributes
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 10
        burstLimit: 20
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserAttributesFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #else
                "statusCode": 200,
                "success": true,
                "data": {
                  "userId": "user-${context.requestId.substring(0,8)}",
                  "profile": {
                    "firstName": "John",
                    "lastName": "Doe",
                    "email": "j***e@example.com",
                    "phoneNumber": "+1****4321",
                    "dateOfBirth": "1990-**-**",
                    "timezone": "America/New_York",
                    "language": "en-US"
                  },
                  "preferences": {
                    "notifications": {
                      "email": true,
                      "sms": false,
                      "push": true
                    },
                    "security": {
                      "mfaEnabled": true,
                      "loginNotifications": true
                    }
                  },
                  "verification": {
                    "email": {
                      "verified": true,
                      "verifiedAt": "$util.time.nowMinus(30 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    },
                    "phone": {
                      "verified": true,
                      "verifiedAt": "$util.time.nowMinus(15 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                    }
                  },
                  "metadata": {
                    "createdAt": "$util.time.nowMinus(60 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "updatedAt": "$util.time.nowMinus(5 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "lastLoginAt": "$util.time.nowMinus(2 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "lastPasswordChangeAt": "$util.time.nowMinus(45 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                }
              #end
            }
        responses:
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,  
                  "message": "User attributes retrieved successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      responses:
        "200":
          description: User attributes retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserAttributes"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "404":
          description: User attributes not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotFound"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
    put:
      tags:
        - Profile
      summary: Update user attributes
      description: Update one or more attributes for the authenticated user
      operationId: updateUserAttributes
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${updateUserAttributesFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.profile && !$body.preferences)
                "statusCode": 400,
                "message": "No attributes provided for update",
                "success": false
              #else
                #if($body.profile.email || $body.profile.phoneNumber)
                  "statusCode": 403,
                  "message": "Email and phone number cannot be updated through this endpoint",
                  "success": false
                #else
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "userId": "user-${context.requestId.substring(0,8)}",
                    "profile": {
                      #if($body.profile.firstName)"firstName": "$body.profile.firstName",#end
                      #if($body.profile.lastName)"lastName": "$body.profile.lastName",#end
                      "email": "j***e@example.com",
                      "phoneNumber": "+1****4321",
                      #if($body.profile.dateOfBirth)"dateOfBirth": "$body.profile.dateOfBirth",#end
                      #if($body.profile.timezone)"timezone": "$body.profile.timezone",#end
                      #if($body.profile.language)"language": "$body.profile.language"#end
                    },
                    "preferences": {
                      #if($body.preferences.notifications)
                      "notifications": $input.json('$.preferences.notifications'),
                      #end
                      #if($body.preferences.security)
                      "security": $input.json('$.preferences.security')
                      #end
                    },
                    "metadata": {
                      "updatedAt": "$util.time.nowFormatted()",
                      "modifiedFields": [
                        #foreach($key in $body.keySet())
                        "$key"#if($foreach.hasNext),#end
                        #end
                      ]
                    }
                  }
                #end
              #end
            } 
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "403":
            statusCode: 403
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "FORBIDDEN",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "User attributes updated successfully",
                  "data": $input.json('$.data'),
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserAttributesRequest"
      responses:
        "200":
          description: Attributes updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateUserAttributesResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unauthorized"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InternalServerError"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceUnavailable"
  
  /phone/verify/initiate:
    post:
      tags:
        - Phone Verification
      summary: Initiate phone verification
      description: Start phone verification process by sending verification code
      operationId: initiatePhoneVerification
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 2
        burstLimit: 3
      security:
        - CognitoAuth: []
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${initiatePhoneVerificationFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.phoneNumber)
                "statusCode": 400,
                "message": "Phone number is required",
                "success": false
              #elseif(!$body.phoneNumber.matches("^\\+[1-9]\\d{1,14}$"))
                "statusCode": 400,
                "message": "Invalid phone number format. Must be in E.164 format",
                "success": false
              #else
                #set($maskedPhone = $body.phoneNumber.substring(0,4) + "****" + $body.phoneNumber.substring($body.phoneNumber.length() - 4))
                "statusCode": 200,
                "success": true,
                "data": {
                  "verificationId": "ver-${context.requestId.substring(0,8)}",
                  "phoneNumber": "$maskedPhone",
                  "deliveryMethod": "SMS",
                  "attemptsRemaining": 3,
                  "expiresIn": 300,
                  "nextRetryAllowed": "$util.time.nowPlus(30 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                  "requestTimestamp": "$util.time.nowFormatted()"
                }
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Too many verification attempts",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Please try again later",
                    "cooldownPeriod": 300,
                    "nextAttemptAllowed": "$util.time.nowPlus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Verification code sent successfully",
                  "data": {
                    "verificationId": "$input.path('$.data.verificationId')",
                    "phoneNumber": "$input.path('$.data.phoneNumber')",
                    "deliveryMethod": "$input.path('$.data.deliveryMethod')",
                    "attemptsRemaining": $input.path('$.data.attemptsRemaining'),
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "nextRetryAllowed": "$input.path('$.data.nextRetryAllowed')",
                    "requestTimestamp": "$input.path('$.data.requestTimestamp')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiateVerificationRequest'
      responses:
        '200':
          description: Verification code sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitiateVerificationResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequest'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unauthorized'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceUnavailable'
  
  /phone/verify/check:
    post:
      tags:
        - Phone Verification
      summary: Verify phone number
      description: Verify phone number using verification code
      operationId: verifyPhoneNumber
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 3
        burstLimit: 5
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
           #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${verifyPhoneNumberFunctionArn}/invocations"
        #httpMethod: POST
        #connectionType: INTERNET
        #type: aws_proxy
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.verificationId || !$body.code)
                "statusCode": 400,
                "message": "Verification ID and code are required",
                "success": false
              #elseif($body.code.length() != 6 || !$body.code.matches("[0-9]+"))
                "statusCode": 400,
                "message": "Invalid verification code format",
                "success": false
              #else
                #set($validCode = "123456")
                #if($body.code == $validCode)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "verificationId": "$body.verificationId",
                    "phoneNumber": "+1****4321",
                    "status": "VERIFIED",
                    "verifiedAt": "$util.time.nowFormatted()",
                    "validUntil": "$util.time.nowPlus(365 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                #else
                  "statusCode": 400,
                  "success": false,
                  "message": "Invalid verification code",
                  "remainingAttempts": 2
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')",
                    #if($input.path('$.remainingAttempts'))
                    "remainingAttempts": $input.path('$.remainingAttempts')
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "410":
            statusCode: 410
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "Verification code has expired",
                  "error": {
                    "code": "CODE_EXPIRED",
                    "details": "Please request a new verification code"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Phone number verified successfully",
                  "data": {
                    "verificationId": "$input.path('$.data.verificationId')",
                    "phoneNumber": "$input.path('$.data.phoneNumber')",
                    "status": "$input.path('$.data.status')",
                    "verifiedAt": "$input.path('$.data.verifiedAt')",
                    "validUntil": "$input.path('$.data.validUntil')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyPhoneRequest'
      responses:
        '200':
          description: Phone number verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyPhoneResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequest'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unauthorized'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceUnavailable'

  /phone/verify/status:
    get:
      tags:
        - Phone Verification
      summary: Get verification status
      description: Get current status of phone verification process
      operationId: getVerificationStatus
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 5
        burstLimit: 10
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getVerificationStatusFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($verificationId = $input.params('verificationId'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$verificationId)
                "statusCode": 400,
                "message": "Verification ID is required",
                "success": false
              #elseif(!$verificationId.startsWith("ver-"))
                "statusCode": 400,
                "message": "Invalid verification ID format",
                "success": false
              #else
                #set($random = $util.random(0, 3))
                #if($random == 0)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "verificationId": "$verificationId",
                    "phoneNumber": "+1****4321",
                    "status": "PENDING",
                    "attemptsRemaining": 3,
                    "expiresIn": 250,
                    "createdAt": "$util.time.nowMinus(50 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "lastAttemptAt": null,
                    "nextAttemptAllowed": "$util.time.nowFormatted()"
                  }
                #elseif($random == 1)
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "verificationId": "$verificationId",
                    "phoneNumber": "+1****4321",
                    "status": "VERIFIED",
                    "attemptsRemaining": 0,
                    "expiresIn": 0,
                    "createdAt": "$util.time.nowMinus(300 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "verifiedAt": "$util.time.nowMinus(200 * 1000).format('yyyy-MM-dd HH:mm:ss')",
                    "validUntil": "$util.time.nowPlus(365 * 24 * 60 * 60 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                #else
                  "statusCode": 404,
                  "success": false,
                  "message": "Verification not found"
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "404":
            statusCode: 404
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "NOT_FOUND",
                    "details": "Verification process not found"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Verification status retrieved successfully",
                  "data": {
                    "verificationId": "$input.path('$.data.verificationId')",
                    "phoneNumber": "$input.path('$.data.phoneNumber')",
                    "status": "$input.path('$.data.status')",
                    "attemptsRemaining": $input.path('$.data.attemptsRemaining'),
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "createdAt": "$input.path('$.data.createdAt')",
                    #if($input.path('$.data.lastAttemptAt'))
                    "lastAttemptAt": "$input.path('$.data.lastAttemptAt')",
                    #end
                    #if($input.path('$.data.verifiedAt'))
                    "verifiedAt": "$input.path('$.data.verifiedAt')",
                    "validUntil": "$input.path('$.data.validUntil')",
                    #else
                    "nextAttemptAllowed": "$input.path('$.data.nextAttemptAllowed')"
                    #end
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }   
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhoneNumber'
      responses:
        '200':
          description: Verification status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhoneNumberVerificationStatus'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequest'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unauthorized'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceUnavailable'

  /phone/verify/resend:
    post:
      tags:
        - Phone Verification
      summary: Resend verification code
      description: Request a new verification code for ongoing verification
      operationId: resendVerificationCode
      security:
        - CognitoAuth: []
      parameters:
        - in: header
          name: SecurityScheme
          required: true
          description: Bearer token for authentication
          schema:
            type: string
            pattern: '^Bearer\s[\w-]+\.[\w-]+\.[\w-]+$'
          example: "Bearer eyJhbGciOiJIUzI1NiIs..."
        - in: header
          name: Accept-Language
          required: false
          description: Preferred response language
          schema:
            type: string
            default: "en-US"
            pattern: '^[a-z]{2}-[A-Z]{2}$'
      x-amazon-apigateway-throttling:
        rateLimit: 2
        burstLimit: 3
      x-amazon-apigateway-integration:
        #uri: 
          #Fn::Sub: 
            #- "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${resendVerificationCodeFunctionArn}/invocations"
        #httpMethod: POST
        #type: aws_proxy
        #connectionType: INTERNET
        type: 'mock'
        payloadFormatVersion: "2.0"
        requestTemplates:
          application/json: |
            #set($body = $input.path('$'))
            #set($authHeader = $input.params().header.get('Authorization'))
            #set($context.responseOverride.header.Content-Type = "application/json")
            {
              #if(!$authHeader || !$authHeader.startsWith("Bearer "))
                "statusCode": 401,
                "message": "Missing or invalid authorization token",
                "success": false
              #elseif(!$body.verificationId)
                "statusCode": 400,
                "message": "Verification ID is required",
                "success": false
              #elseif(!$body.verificationId.startsWith("ver-"))
                "statusCode": 400,
                "message": "Invalid verification ID format",
                "success": false
              #else
                #set($resendCount = $util.random(0, 4))
                #if($resendCount >= 3)
                  "statusCode": 429,
                  "message": "Maximum resend attempts reached",
                  "success": false,
                  "cooldownPeriod": 300
                #else
                  "statusCode": 200,
                  "success": true,
                  "data": {
                    "verificationId": "$body.verificationId",
                    "phoneNumber": "+1****4321",
                    "deliveryMethod": "SMS",
                    "resendCount": $resendCount,
                    "remainingResends": #set($remaining = 3 - $resendCount)$remaining,
                    "expiresIn": 300,
                    "requestTimestamp": "$util.time.nowFormatted()",
                    "nextResendAllowed": "$util.time.nowPlus(30 * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  }
                #end
              #end
            }
        responses:
          "400":
            statusCode: 400
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "VALIDATION_ERROR",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "401":
            statusCode: 401
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "UNAUTHORIZED",
                    "details": "$input.path('$.message')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          "429":
            statusCode: 429
            responseTemplates:
              application/json: |
                {
                  "success": false,
                  "message": "$input.path('$.message')",
                  "error": {
                    "code": "RATE_LIMIT_EXCEEDED",
                    "details": "Maximum resend attempts reached",
                    "cooldownPeriod": $input.path('$.cooldownPeriod'),
                    "nextAttemptAllowed": "$util.time.nowPlus($input.path('$.cooldownPeriod') * 1000).format('yyyy-MM-dd HH:mm:ss')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "requestId": "$context.requestId",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }
          default:
            statusCode: 200
            responseTemplates:
              application/json: |
                {
                  "success": true,
                  "message": "Verification code resent successfully",
                  "data": {
                    "verificationId": "$input.path('$.data.verificationId')",
                    "phoneNumber": "$input.path('$.data.phoneNumber')",
                    "deliveryMethod": "$input.path('$.data.deliveryMethod')",
                    "resendCount": $input.path('$.data.resendCount'),
                    "remainingResends": $input.path('$.data.remainingResends'),
                    "expiresIn": $input.path('$.data.expiresIn'),
                    "requestTimestamp": "$input.path('$.data.requestTimestamp')",
                    "nextResendAllowed": "$input.path('$.data.nextResendAllowed')"
                  },
                  "metadata": {
                    "timestamp": "$context.requestTime",
                    "region": "$context.identity.sourceIp",
                    "userAgent": "$context.identity.userAgent",
                    "path": "$context.resourcePath",
                    "httpMethod": "$context.httpMethod"
                  }
                }     
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResendCodeRequest'
      responses:
        '200':
          description: Verification code resent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResendCodeResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequest'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unauthorized'
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'  
    
components:
  schemas:
    UserAttributes:
      description: User profile information
      type: object
      properties:
        profile:
          $ref: '#/components/schemas/UserProfile'
        preferences:
          $ref: '#/components/schemas/UserPreferences'
    
    UserProfile:
      type: object
      properties:
        email:
          type: string
          format: email
          description: email of the user
        firstName:
          type: string
          description: First name of the user
        lastName:
          type: string
          description: Last name of the user
        dateOfBirth:
          type: string
          format: date
          description: Date of birth of the user
        timezone:
          type: string
          description: Time zone of the user
        language:
          type: string
          description: Preferred language of the user
        brandName:
          type: string
          description: membership name (brand name)
        phoneNumber:
          type: string
          pattern: '^\+[1-9]\d{1,14}$'
          description: phone number of the user
        emailVerified:
          type: boolean
          description: email verification status
        phoneVerified:
          type: boolean
          description: phone number verificaion status
        country:
          type: string
          description: Country of the user
        jobTitle:
          type: string
          description: Job title of the user
        company:
          type: string
          description: Company of the user
        createdAt:
          type: string
          format: date-time
          description: Date and time when the user was created
        lastLoginAt:
          type: string
          format: date-time
          description: Date and time of the last login
        mfaEnabled:
          type: boolean
          description: Indicates if MFA is enabled for the user
        preferences:
          $ref: '#/components/schemas/UserPreferences'

    UserPreferences:
      type: object
      description: User preferences configuration
      required:
        - notifications
        - security
      properties:
        language:
          type: string
          description: Preferred language of the user
        timezone:
          type: string
          description: Time zone of the user
        notifications:
          type: object
          description: Notification settings
          properties:
            email:
              type: boolean
            sms:
              type: boolean
        security:
          type: object
          description: Security settings
          required:
            - mfaEnabled
            - loginNotifications
          properties:
            mfaEnabled:
              type: boolean
              description: Whether MFA is enabled
              default: false
            loginNotifications:
              type: boolean
              description: Whether to send notifications on login
              default: true
            lastPasswordChange:
              type: string
              format: date-time
              description: the last time password was changed
      example:
        notifications:
          email: true
          sms: false
          push: true
        security:
          mfaEnabled: true
          loginNotifications: true

    SignUpRequest:
      description: Request body for user sign-up
      type: object
      required:
        - email
        - password
        - firstName
        - lastName
        - brandName
        - jobTitle
        - country
      properties:
        email:
          type: string
          format: email
          description: Email address of the user
          pattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        password:
          type: string
          minLength: 8
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$'
          description: Must contain at least one uppercase letter, one lowercase letter, one number and one special character
        firstName:
          type: string
          minLength: 2
          description: First name of the user
        lastName:
          type: string
          minLength: 2
          description: Last name of the user
        brandName:
          type: string
          minLength: 2
          maxLength: 12
          description: Brand name of the user
        country:
          type: string
          minLength: 1
          description: Country of the user
        jobTitle:
          type: string
          minLength: 1
          description: Job title of the user
        company:
          type: string
          minLength: 1
          description: Company of the user

    SignUpResponse:
      description: Response body for user sign-up
      type: object
      properties:
        verificationRequired:
          type: boolean
          description: Indicates if the user needs to verify their email address
        message:
          type: string
          description: Message describing the result of the sign-up attempt

    ConfirmSignUpRequest:
      type: object
      description: Request body for confirming a user's sign-up
      required:
        - session
      properties:
        session:
          type: string
          description: Session ID for the Signup verification (code, sessionId, email and timestamp)

    ConfirmSignUpResponse:
      description: Response body for confirming a user's sign-up
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the sign-up was successful
        message:
          type: string
          description: Message describing the result of the confirmation attempt

    SignInRequest:
      description: Request body for user sign-in
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: Email address of the user
        password:
          type: string
          description: Password of the user
          example: "P@ssw0rd123!"

    SignInResponse:
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the sign-in was successful
        message:
          type: string
          description: Response message describing the result of the sign-in attempt
        data:
          type: object
          properties:
            accessToken:
              type: string
              description: JWT access token for the user
            refreshToken:
              type: string
              description: JWT refresh token for the user
            idToken:
              type: string
              description: JWT ID token for the user
            expiresIn:
              type: integer
              description: Number of seconds until the access token expires
            tokenType:
              type: string
              description: Type of token, always 'Bearer'
            mfaRequired:
              type: boolean
              description: Indicates if the user needs to complete multi-factor authentication
            mfaSession:
              type: string
              description: Session ID for the multi-factor authentication flow
            loginTimestamp:
              type: string
              format: date-time

    EmailVerificationRequest:
      description: Request body for verifying a user's email address
      type: object
      required:
        - code
      properties:
        session:
          type: string
          description: Session ID for the MFA verification

    EmailVerificationResponse:
      description: Response body for verifying a user's email address
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the email verification was successful
        message:
          type: string
          description: Message describing the result of the email verification attempt
          example: "Email verification successful"

    TokenResponse:
      description: token response
      type: object
      properties:
        accessToken:
          description: Access token for the user
          type: string
        idToken:
          description: ID token for the user
          type: string
        refreshToken:
          description: Refresh token for the user
          type: string
        expiresIn:
          description: seconds remaining before the token expires
          type: integer

    UsernameRecoveryRequest:
      type: object
      required:
        - firstName
        - lastName
        - brandName
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-zA-Z\s-]+$'
          description: User's first name
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-zA-Z\s-]+$'
          description: User's last name
        brandName:
          type: string
          minLength: 1
          maxLength: 100
          description: User's membership name(brand name)

    UsernameRecoveryResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        username:
          type: string
          description: Recovered username (masked)
        rateLimitInfo:
          $ref: "#/components/schemas/RateLimitInfo"

    RateLimitsResponse:
      type: object
      properties:
        accountId:
          type: string
        tier:
          type: string
          enum: [standard, premium]
        currentUsage:
          type: object
          properties:
            daily_requests:
              type: integer
            current_rate:
              type: number
        limits:
          type: object
          properties:
            requests_per_second:
              type: integer
            burst_limit:
              type: integer
            daily_quota:
              type: integer
        resetTime:
          type: string
        nextResetTime:
          type: string
        throttling:
          type: object
          properties:
            enabled:
              type: boolean
            soft_limit:
              type: boolean
            hard_limit:
              type: boolean
        metadata:
          type: object
          properties:
            region:
              type: string
            lastUpdated:
              type: string
            requestId:
              type: string
    
    RateLimitStatus:
      type: object
      properties:
        endpoints:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/RateLimitInfo'

    RateLimitInfo:
      type: object            
      properties:
        message:
          type: string
          description: Error message
        limit:
          type: integer
          description: Maximum requests allowed in the time window
        remaining:
          type: integer
          description: Remaining requests in the current window
        reset:
          type: string
          format: date-time
          description: Time when the rate limit resets
        retryAfter:
          type: integer
          description: Seconds until next request is allowed (when limited)
        window:
          type: integer
          description: Time window in seconds
        resetTime:
          type: string
          format: date-time
          description: Time when the rate limit will be reset
          example: "2023-04-01T00:00:00Z"
    
    SignOutResponse:
      description: Response body for user sign-out
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the sign-out was successful
        message:
          type: string
          description: Message describing the result of the sign-out attempt

    ChangePasswordRequest:
      description: Request body for changing a user's password
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          minLength: 8
          description: Current password of the user
        newPassword:
          type: string
          minLength: 8
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$'
          description: Must contain at least one uppercase letter, one lowercase letter, one number and one special character
          example: "NewPassword123!"

    ChangePasswordResponse:
      description: Response body for changing a user's password
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the password change was successful
        message:
          type: string
          description: Message describing the result of the password change attempt
    
    MFASetupResponse:
      description: Response body for setting up multi-factor authentication
      type: object
      properties:
        secretCode:
          type: string
          description: Base32 encoded secret key for the user
        qrCodeUrl:
          type: string
          description: URL for the QR code to be scanned by the user
        backupCodes:
          description: Backup codes are used in case the user cannot receive the QR code
          type: array
          items:
            type: string
            description: Backup code for the user
    
    MFASetupVerificationRequest:
      description: Request body for verifying a user's MFA
      type: object
      required:
        - mfaSession
        - code
      properties:
        code:
          type: string
          pattern: "^[0-9]{6}$"
          description: 6-digit verification code
        mfaSession:
          type: string
          description: Session ID token received from sign-in

    MFASetupVerificationResponse:
      type: object
      required:
        - success
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          description: Indicates if the verification was successful
          example: true
        message:
          type: string
          description: Human-readable message describing the result
          example: "MFA setup verified successfully"
        data:
          type: object
          properties:
            userId:
              type: string
              description: User identifier
              example: "user-12345678"
            verificationTime:
              type: string
              format: date-time
              description: Verification timestamp
            status:
              type: string
              enum: [ENABLED]
              description: MFA status after verification
            nextVerificationRequired:
              type: string
              format: date-time
              description: Next verification requirement timestamp
        metadata:
          $ref: "#/components/schemas/ResponseMetadata"
    
    MFASigninVerificationRequest:
      type: object
      required:
        - mfaToken
        - code
      properties:
        mfaSessionToken:
          type: string
          description: MFA session token received from sign-in
        code:
          type: string
          pattern: "^[0-9]{6}$"
          description: 6-digit verification code

    MFASigninVerificationResponse:
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the verification was successful
        message:
          type: string
          description: Response message
        data:
          type: object
          properties:
            accessToken:
              type: string
            refreshToken:
              type: string
            tokenType:
              type: string
            expiresIn:
              type: integer
            userId:
              type: string
            sessionId:
              type: string
            verificationTime:
              type: string
              format: date-time
            permissions:
              type: array
              items:
                type: string

    MFAResendRequest:
      description: Request body for resending the MFA token
      type: object
      required:
        - mfaSession
        - deliveryMedium
      properties:
        mfaSession:
          type: string
          description: MFA token received during sign-in
          example: "mfa-abc123def456"
        deliveryMedium:
          description: Medium through which the reset code was sent
          type: string
          enum: [EMAIL, SMS]

    MFAResendResponse:
      description: Response body for resending the MFA token
      type: object
      required:
        - success
        - message
        - data
        - metadata
      properties:
        success:
          type: boolean
          description: Indicates if the resend was successful
          example: true
        message:
          type: string
          description: Message describing the result of the resend attempt
          example: "MFA code resent successfully"
        deliveryMedium:
          type: string
          enum: [EMAIL, SMS]
          description: Medium through which the reset code was sent
        destination:
          type: string
          description: Masked email or phone number where code was sent
          example: "j***@example.com"
        data:
          type: object
          properties:
            mfaToken:
              type: string
              description: MFA token for verification
              example: "mfa-abc123def456"
            deliveryMethod:
              type: string
              enum: [EMAIL, SMS]
              description: Method used to deliver the code
              example: "EMAIL"
            maskedDestination:
              type: string
              description: Masked email or phone number
              example: "t***t@example.com"
            resendCount:
              type: integer
              description: Number of times code has been resent
              example: 1
            remainingResends:
              type: integer
              description: Number of remaining resend attempts
              example: 2
            requestTime:
              type: string
              format: date-time
              description: Time of resend request
            expiresIn:
              type: integer
              description: Seconds until code expires
              example: 300
            nextResendAllowed:
              type: string
              format: date-time
              description: Time when next resend is allowed
        metadata:
          type: object
          properties:
            timestamp:
              type: string
              format: date-time
              description: Request timestamp
            region:
              type: string
              description: Region where request was processed
              example: "us-east-1"
            userAgent:
              type: string
              description: User agent of the client
            path:
              type: string
              description: API path
              example: "/auth/mfa/resend"
            httpMethod:
              type: string
              description: HTTP method used
              example: "POST"

    EnableMfaRequest:
      type: object
      description: Request body for enabling MFA
      required:
        - mfaType
        - code
      properties:
        mfaType:
          type: string
          enum: [SMS, EMAIL, TOTP]
          description: Type of MFA to enable
          example: "TOTP"
        code:
          type: string
          pattern: "^[0-9]{6}$"
          description: Verification code
          example: "123456"

    EnableMfaResponse:
      description: Response body for enabling MFA
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the MFA was successfully enabled
        message:
          type: string
          description: Message describing the result of the enable MFA attempt
        data:
          type: object
          properties:
            mfaEnabled:
              type: boolean
            mfaType:
              type: string
              enum: [TOTP, SMS, EMAIL]
            enabledAt:
              type: string
              format: date-time
            backupCodes:
              type: array
              items:
                type: string
              description: Backup codes for account recovery
            recoveryEmail:
              type: string

    DisableMfaRequest:
      description: Request body for disabling MFA
      type: object
      required:
        - mfaType
        - code
      properties:
        mfaType:
          type: string
          enum: [SMS, EMAIL, TOTP]
          description: Type of MFA to disable
        code:
          type: string
          pattern: "^[0-9]{6}$"
          description: Current MFA verification code
          example: "123456"

    DisableMfaResponse:
      type: object
      required:
        - success
        - message
        - data
      description: Response body for disabling MFA
      properties:
        success:
          type: boolean
          description: Indicates if the MFA was successfully disabled
        message:
          type: string
          description: Message describing the result of the disable MFA attempt
        data:
          type: object
          properties:
            mfaEnabled:
              type: boolean
            disabledAt:
              type: string
              format: date-time
            securityNotice:
              type: string

    MfaPreferenceRequest:
      description: Request body for setting MFA preference
      type: object
      properties:
        mfaEnabled:
          type: boolean
          description: Whether MFA is enabled for the user
        preferredMethod:
          description: Preferred MFA method
          type: string
          enum: [SMS, EMAIL, TOTP]
        methods:
          type: object
          properties:
            smsSettings:
              description: SMS settings for MFA
              type: object
              properties:
                enabled:
                  description: Whether SMS is enabled as a preferred MFA method
                  type: boolean
                phoneNumber:
                  description: Phone number for SMS MFA
                  type: string
                  pattern: '^\+[1-9]\d{1,14}$'
            emailSettings:
              description: Email settings for MFA
              type: object
              properties:
                enabled:
                  description: Whether email is enabled as a preferred MFA method
                  type: boolean
                email:
                  description: Email address for email MFA
                  type: string
                  format: email
            totpSettings:
              description: TOTP settings for MFA
              type: object
              properties:
                enabled:
                  description: Whether TOTP is enabled as a preferred MFA method
                  type: boolean
        securitySettings:
          type: object
          properties:
            rememberDevice:
              type: boolean
            rememberDeviceDays:
              type: integer
              minimum: 1
              maximum: 90
            requireMfaOnNewDevice:
              type: boolean
            requireMfaOnLoginFromNewLocation:
              type: boolean

    MfaPreferenceResponse:
      description: Response body for setting MFA preference
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the MFA preference was successfully set
        message:
          type: string
          description: Message describing the result of the set MFA preference attempt
        verificationRequired:
          type: boolean
          description: Indicates if the user needs to verify their email address
        verificationDetails:
          description: List of attributes that require verification
          type: object
          properties:
            method:
              type: string
              enum: [SMS, EMAIL]
              description: Method that requires verification
            destination:
              type: string
              description: Masked phone number or email where verification code was sent
              example: "j***@example.com"
    
    PasswordResetRequest:
      description: Request body for initiating a password reset
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address of the user
    
    PasswordResetResponse:
      description: Response body for initiating a password reset
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the reset code was sent successfully
        message:
          type: string
          description: Message describing the result of the reset password attempt
        recoveryId:
          type: string
          description: Unique identifier for the recovery session
        expiresIn:
          type: integer
          description: Seconds until the recovery session expires
        deliveryMedium:
          type: string
          enum: [EMAIL, SMS]
          description: Medium through which the reset code was sent
        maskedDestination:
          type: string
          description: Masked email or phone number where verification code was sent
          example: "j***@example.com"

    ForgotPasswordRequest:
      description: Request body for initiating the forgot password flow
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address of the user

    ForgotPasswordResponse:
      description: Response body for initiating the forgot password flow
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the reset code was sent successfully
        message:
          type: string
          description: Message describing the result of the forgot password attempt
        recoveryId:
          type: string
          description: Unique identifier for the recovery session
        expiresIn:
          type: integer
          description: Seconds until the recovery session expires
        deliveryMedium:
          type: string
          enum: [EMAIL, SMS]
          description: Medium through which the reset code was sent
        maskedDestination:
          type: string
          description: Masked email or phone number where verification code was sent
    
    ConfirmResetPasswordRequest:
      description: Request body for reseting a user's password
      type: object
      required:
        - resetId
        - resetToken
        - newPassword
      properties:
        resetId:
          type: string
          description: Unique identifier for the recovery session
        resetToken:
          type: string
          pattern: "^[0-9]{6}$"
          description: Reset token for the user
        newPassword:
          type: string
          minLength: 8
          format: password
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$'
          description: Must contain at least one uppercase letter, one lowercase letter, one number and one special character
    
    ConfirmForgotPasswordRequest:
      description: Request body for confirming the forgot password flow
      type: object
      required:
        - recoveryId
        - resetToken
        - newPassword
      properties:
        recoveryId:
          type: string
          description: Unique identifier for the recovery session
        resetToken:
          type: string
          description: Reset token for the user
        newPassword:
          type: string
          minLength: 8
          format: password
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$'
          description: Must contain at least one uppercase letter, one lowercase letter, one number and one special character

    ConfirmForgotPasswordResponse:
      description: Response body for confirming the forgot password flow
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the password reset was successful
        message:
          type: string
          description: Message describing the result of the password reset attempt

    ResetPasswordResponse:
      description: Response body for confirming a user's password reset flow
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the password reset was successful
        message:
          type: string
          description: Message describing the result of the reset password attempt
  
    RefreshTokenRequest:
      description: Request body for refreshing an access token
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          description: Valid refresh token previously issued

    RefreshTokenResponse:
      description: Response body for refreshing an access token
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the token refresh was successful
        message:
          type: string
          description: Message describing the result of the token refresh attempt
        data:
          type: object
          required:
            - accessToken
            - refreshToken
            - tokenType
            - expiresIn
          properties:
            accessToken:
              type: string
              description: New access token for the user
            refreshToken:
              type: string
              description: New refresh token
            tokenType:
              description: Type of token
              type: string
              enum: [Bearer]
            expiresIn:
              type: integer
              description: Access token expiration in seconds
            refreshExpiresIn:
              type: integer
              description: Refresh token expiration in seconds
            scope:
              type: string
              description: Token scope
            issuedAt:
              type: string
              format: date-time
              description: Token issuance timestamp
            sessionId:
              type: string
              description: Current session identifier
            deviceInfo:
              description: Information about the device used for authentication
              type: object
              properties:
                deviceId: 
                  description: User device identifier
                  type: string
                ipAddress:
                  description: User ip address 
                  type: string
                userAgent:
                  type: string
                  description: User agent of the client
                location:
                  description: user's location (country)
                  type: string
      
    AccountRecoveryVerificationRequest:
      description: Request body for verifying a user's account recovery
      type: object
      required:
        - recoveryId
        - verificationCode
      properties:
        recoveryId:
          type: string
          description: Unique identifier for the recovery session
        verificationCode:
          type: string
          pattern: "^[0-9]{6}$"
          description: 6-digit verification code sent to the user
          example: "123456"

    AccountRecoveryVerificationResponse:
      description: Response body for verifying a user's account recovery
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        temporaryAccessToken:
          type: string
          description: Temporary token for password reset
        expiresIn:
          type: integer
          description: Seconds until the temporary token expires
          example: 3600
        
    UpdateUserAttributesRequest:
      description: Request body for updating user attributes
      type: object
      properties:
        profile:
          $ref: '#/components/schemas/UserProfile'
        

    UpdateUserAttributesResponse:
      description: Response body for updating user attributes
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the update was successful
        message:
          type: string
          description: Message describing the result of the update attempt
        verificationRequired:
          type: boolean
          description: Indicates if the user needs to verify their email address
        verificationAttributes:
          description: List of attributes that require verification
          type: array
          items:
            type: string
            enum: [email, phone_number]
            description: Attributes that require verification

    InitiateVerificationRequest:
      description: Request body for initiating phone number verification
      type: object
      required:
        - phoneNumber
      properties:
        phoneNumber:
          type: string
          pattern: '^\+[1-9]\d{1,14}$'
          description: Phone number in E.164 format
        locale:
          type: string
          default: 'en'
          description: Preferred language for SMS
        channel:
          type: string
          enum: [SMS, CALL]
          default: SMS
          description: Verification channel

    InitiateVerificationResponse:
      description: Response body for initiating phone number verification
      type: object
      required:
        - success
        - message
        - data
      properties:
        success: 
          type: boolean
          description: Indicates if the phone number verification was initiated successfully
        message:
          type: string
          description: Message describing the result of the phone number verification initiation
        data:
          type: object
          properties:
            verificationId:
              type: string
              description: Unique verification identifier
            phoneNumber:
              type: string
              description: Masked phone number
            deliveryMethod:
              type: string
              enum: [SMS, CALL]
            attemptsRemaining:
              type: integer
              description: Number of verification attempts remaining
            expiresIn:
              type: integer
              description: Seconds until code expires
            nextRetryAllowed:
              type: string
              format: date-time
            requestTimestamp:
              type: string
              format: date-time
        rateLimitInfo:
          $ref: '#/components/schemas/RateLimitInfo'

    VerifyPhoneRequest:
      description: Request body for verifying a phone number
      type: object
      required:
        - verificationId
        - code
      properties:
        verificationId:
          type: string
          description: Verification session identifier
        code:
          type: string
          pattern: "^[0-9]{6}$"
          description: 6-digit verification code sent to the user's phone number

    VerifyPhoneResponse:
      description: Response body for verifying a phone number
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the phone number verification was successful
        message:
          type: string
          description: Message describing the result of the phone number verification
        verified:
          type: boolean
          description: Indicates if the phone number is verified
        data:
          type: object
          properties:
            verificationId:
              type: string
            phoneNumber:
              type: string
              description: Masked phone number
            status:
              type: string
              enum: [VERIFIED, FAILED]
            verifiedAt:
              type: string
              format: date-time 
            validUntil:
              type: string
              format: date-time
        rateLimitInfo:
          $ref: '#/components/schemas/RateLimitInfo'

    PhoneNumber:
      description: Phone number details
      type: object
      properties:
        phoneNumber:
          type: string
          pattern: '^\+[1-9]\d{1,14}$'
          description: Phone number 
        rateLimitInfo:
          $ref: '#/components/schemas/RateLimitInfo'

    PhoneNumberVerificationStatus:
      description: Response body for verification status
      type: object
      properties:
        phoneNumber:
          type: string
          pattern: '^\+[1-9]\d{1,14}$'
          description: Masked phone number where verification code was sent
        status:
          type: string
          enum: [PENDING, VERIFIED, FAILED, EXPIRED]
          description: Status of the verification
        verifiedAt:
          type: string
          format: date-time
          description: Time when the phone number was verified
        attemptsRemaining:
          type: integer
          description: Number of verification attempts remaining
        lastAttempt:
          type: string
          format: date-time
          description: Time when the last verification attempt was made
        expiresAt:
          type: string
          format: date-time
          description: Time when the verification code expires
        rateLimitInfo:
          $ref: '#/components/schemas/RateLimitInfo'
    
    ResendCodeRequest:
      description: Request body for resending a verification code
      type: object
      required:
        - verificationId
      properties:
        verificationId:
          type: string
          description: Verification session identifier
        channel:
          description: Verification channel
          type: string
          enum: [SMS, CALL]
          default: SMS
        recaptchaToken:
          type: string
          description: Google reCAPTCHA token

    ResendCodeResponse:
      description: Response body for resending a verification code
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the verification code was successfully resent
        message:
          type: string
          description: Message describing the result of the verification code resend
        data:
          type: object
          properties:
            verificationId:
              type: string
              description: Unique verification identifier 
            phoneNumber:
              type: string
              description: Masked phone number where verification code was sent
            deliveryMethod:
              type: string
              enum: [SMS]
              description: Delivery method of the verification code
            resendCount:
              type: integer
              description: Number of times the verification code has been resent
            attemptsRemaining:
              type: integer
              description: Number of verification attempts remaining
            expiresIn:
              type: integer
              description: Seconds until verification code expires
            requestTimestamp:
              type: string
              format: date-time
              description: Time when the verification code was requested
            nextResendAllowed:
              type: string
              format: date-time
              description: Time when the next resend attempt is allowed
        rateLimitInfo:
          $ref: '#/components/schemas/RateLimitInfo'
    
    ResponseMetadata:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Request timestamp
        region:
          type: string
          description: Region where request was processed
        userAgent:
          type: string
          description: User agent of the client
        path:
          type: string
          description: API path
        httpMethod:
          type: string
          description: HTTP method used

    Error:
      description: Error response body
      type: object
      properties:
        code:
          description: Error code
          type: string
          enum:
            - BadRequest
            - Unauthorized
            - Forbidden
            - MaxAttemptReached
            - rateLimited
            - VerificationFailed
            - ExpiredCode
            - Conflict
            - InternalServerError
        message:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details
          additionalProperties: true
        rateLimitInfo:
          $ref: "#/components/schemas/RateLimitInfo"

    TooManyMfaRequests:
      type: object
      required:
        - success
        - message
        - error
        - metadata
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Maximum resend attempts reached"
        error:
          type: object
          properties:
            code:
              type: string
              example: "RATE_LIMIT_EXCEEDED"
            details:
              type: string
              example: "Maximum resend attempts reached"
            cooldownPeriod:
              type: integer
              description: Seconds until next attempt is allowed
              example: 300
            nextAttemptAllowed:
              type: string
              format: date-time
              description: Time when next attempt is allowed
        metadata:
          type: object
          properties:
            timestamp:
              type: string
              format: date-time
            requestId:
              type: string
            path:
              type: string
            httpMethod:
              type: string

    TooManyRequests:
      description: Rate limit exceeded
      properties:
        schema:
          $ref: "#/components/schemas/RateLimitInfo"

    BadRequest:
      description: Invalid request
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    Unauthorized:
      description: Authentication required
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    Forbidden:
      description: Permission denied
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    Conflict:
      description: Resource already exists
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    NotFound:
      description: Resource not found
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    ServiceUnavailable:
      description: Service unavailable
      properties:
        schema:
          $ref: "#/components/schemas/Error"

    InternalServerError:
      description: Internal server error
      properties:
        schema:
          $ref: "#/components/schemas/Error"

  securitySchemes:
    CognitoAuth:
      description: Cognito User Pools Authorizer
      type: apiKey
      name: SecurityScheme
      in: header
      x-amazon-apigateway-authtype: aws_iam
      x-amazon-apigateway-authorizer:
        type: aws_iam
        jwtConfiguration:
          issuer: ${cognito_issuer}
          audience:
            - ${cognito_client_id}
        identitySource: $request.header.Authorization